From patchwork Fri Apr 30 14:37:49 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Aaron Lewis <aaronlewis@google.com>
X-Patchwork-Id: 12233567
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-21.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,USER_AGENT_GIT,
	USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id A529EC433ED
	for <kvm@archiver.kernel.org>; Fri, 30 Apr 2021 14:37:56 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 69664613D9
	for <kvm@archiver.kernel.org>; Fri, 30 Apr 2021 14:37:56 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230379AbhD3Oin (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 30 Apr 2021 10:38:43 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:49140 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230297AbhD3Oim (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 30 Apr 2021 10:38:42 -0400
Received: from mail-pl1-x649.google.com (mail-pl1-x649.google.com
 [IPv6:2607:f8b0:4864:20::649])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AC7D9C06174A
        for <kvm@vger.kernel.org>; Fri, 30 Apr 2021 07:37:54 -0700 (PDT)
Received: by mail-pl1-x649.google.com with SMTP id
 m10-20020a170902f20ab02900ed7e32ff42so3716260plc.19
        for <kvm@vger.kernel.org>; Fri, 30 Apr 2021 07:37:54 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=date:message-id:mime-version:subject:from:to:cc;
        bh=v5lYu1w+irOCEZJQl/ANzvss1KKbzTlcUMWMr3wEwIU=;
        b=hLsvwn8xKe2dyxS2t6qKV/Q5tQNoF5Y92f3eXV85RZYbprYcxDuoixMIirnaU19+Pi
         yxN6SbDbHnyJGrriQBg0ozX//CtWauQqON9Xk0LZj8V7/TaFOCV7Kcl+ElSf3XFdDZPw
         Q5qF9Qc2H/Z3m1Sn+HRsAI4N3H66VEHQdWsfbAHg6hryDlRXeM2CJy3ceo0qi2I5H1vs
         e12eLUE7BpEX4C/ZYeXheUA8N6/qzt+lQxFhtbMnU+jVUfMvcXQSEpw/rBvSnQo1YB4R
         KnBAYHDU2XDG98RlzRvz3FGcfA+nEvp35M7scYViD9BZGyTUTdd7de6BShISlmr7V4yJ
         R2cA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:date:message-id:mime-version:subject:from:to:cc;
        bh=v5lYu1w+irOCEZJQl/ANzvss1KKbzTlcUMWMr3wEwIU=;
        b=O/ixPkF8BNu5TOn8A6lK1/u/8zv2PkIv+cXC+rx4wwAADZbHUzaIkrPU4/jqDbMB5T
         d6hT+kESAfK+z1gGFlWWPmx7CmoPnpcfg1svDZN1Chj+7LPFuuFmHKsXNsgi39JepoJj
         nDSM8uAvrWFYZYnbqZ832yxBvvELWLrgkBT4KDdfhacTj6dj4LJTUsHEPumOLy+6RPay
         kZgAuFTH/Zkc1JlB3uX6+X7+f/UC4gA6aKqUsa85jP52UALmsRnWCwBKhIeN+SeiiAdy
         LbQ1+KeCBPgdpHrSzhBscAATwK+B7XHmcEhGdrLVgFtc6NUs1lmyuOUJUh7glfdWuwXY
         xjOg==
X-Gm-Message-State: AOAM533Dh9nFjcmdrjemofBqTcNSS+XW/qGMXMIss1xafMHOX9CelBXJ
        jiHEEh+qNpd6nZ/tGt5SdH6af/kyXlZNjZDn
X-Google-Smtp-Source: 
 ABdhPJzVyxCwumdlhXSDRDRuTJTfZ+CAdxm11+hy0w667BUJnxcocTjfduwCPFou+asw+4qL+IEq9wDv0xHGVjBg
X-Received: from aaronlewis1.sea.corp.google.com
 ([2620:15c:100:202:250e:2425:2e40:acc])
 (user=aaronlewis job=sendgmr) by 2002:a17:902:ec84:b029:ea:b28d:e53e with
 SMTP id x4-20020a170902ec84b02900eab28de53emr5327690plg.77.1619793474194;
 Fri, 30 Apr 2021 07:37:54 -0700 (PDT)
Date: Fri, 30 Apr 2021 07:37:49 -0700
Message-Id: <20210430143751.1693253-1-aaronlewis@google.com>
Mime-Version: 1.0
X-Mailer: git-send-email 2.31.1.527.g47e6f16901-goog
Subject: [PATCH v5 0/2] fallback for emulation errors
From: Aaron Lewis <aaronlewis@google.com>
To: david.edmondson@oracle.com, seanjc@google.com, jmattson@google.com
Cc: kvm@vger.kernel.org, Aaron Lewis <aaronlewis@google.com>
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

This patchset allows userspace to be a fallback for handling emulation errors.

v1 -> v2:

 - Added additional documentation for KVM_CAP_EXIT_ON_EMULATION_FAILURE.
 - In prepare_emulation_failure_exit():
   - Created a local variable for vcpu->run.
   - Cleared the flags, emulation_failure.flags.
   - Or'd the instruction bytes flag on to emulation_failure.flags.
 - Updated the comment for KVM_INTERNAL_ERROR_EMULATION flags on how they are
   to be used.
 - Updated the comment for struct emulation_failure.

v2 -> v3:

 - Update documentation for KVM_CAP_EXIT_ON_EMULATION_FAILURE.
 - Fix spacing in prepare_emulation_failure_exit().

v3 -> v4:

 - In prepare_emulation_failure_exit():
   - Clear instruction bytes to 0x90.
   - Copy over insn_size bytes rather than sizeof(ctxt->fetch.data).
 - set_page_table_entry() takes a pte rather than mask.
 - In _vm_get_page_table_entry():
   - Removed check for page aligned addresses only.
   - Added canonical check.
   - Added a check to make sure no reserved bits are set along the walk except
     for the final pte (the pte cannot have the reserved bits checked otherwise
     the test would fail).
   - Added check to ensure superpage bits are clear.
 - Added check in test for 'allow_smaller_maxphyaddr' module parameter.
 - If the is_flds() check fails, only look at the first byte.
 - Don't use labels to increment the RIP.  Decode the instruction well enough to
   ensure it is only 2-bytes.

v4 -> v5:

 - Switch 'insn_size' to u32.
 - Add documentation for how the flags are used.
 - Remove 'max_insn_size' and use 'sizeof(run->emulation_failure.insn_bytes)' instead.
 - Fix typos.
 - Fix canonical check.
 - Add reserved check for bit-7 of PML4E.
 - Add reserved check for bit-63 of all page table levels if EFER.NXE = 0.
 - Remove opcode check (it might be a prefix).
 - Remove labels.
 - Remove detritus (rogue cpuid entry in the test).

Aaron Lewis (2):
  kvm: x86: Allow userspace to handle emulation errors
  selftests: kvm: Allows userspace to handle emulation errors.

 Documentation/virt/kvm/api.rst                |  21 ++
 arch/x86/include/asm/kvm_host.h               |   6 +
 arch/x86/kvm/x86.c                            |  37 ++-
 include/uapi/linux/kvm.h                      |  23 ++
 tools/include/uapi/linux/kvm.h                |  23 ++
 tools/testing/selftests/kvm/.gitignore        |   1 +
 tools/testing/selftests/kvm/Makefile          |   1 +
 .../selftests/kvm/include/x86_64/processor.h  |   4 +
 .../selftests/kvm/lib/x86_64/processor.c      |  94 ++++++++
 .../kvm/x86_64/emulator_error_test.c          | 219 ++++++++++++++++++
 10 files changed, 425 insertions(+), 4 deletions(-)
 create mode 100644 tools/testing/selftests/kvm/x86_64/emulator_error_test.c
